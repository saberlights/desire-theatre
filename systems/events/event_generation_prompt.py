"""
äº‹ä»¶ç”Ÿæˆ Prompt æ¨¡æ¿

ç”¨äºé€šè¿‡ LLM åŠ¨æ€ç”Ÿæˆéšæœºäº‹ä»¶å’Œé€‰æ‹©å›°å¢ƒçš„æ–‡æœ¬å†…å®¹
"""

from typing import Dict, List


class EventGenerationPrompt:
    """äº‹ä»¶ç”Ÿæˆ Prompt æ„å»ºå™¨"""

    @staticmethod
    def build_dynamic_event_prompt(
        character: Dict,
        history: List[Dict] = None
    ) -> str:
        """
        æ„å»ºå®Œå…¨åŠ¨æ€çš„äº‹ä»¶ç”Ÿæˆ Promptï¼ˆåŒ…æ‹¬äº‹ä»¶ç±»å‹ã€é€‰é¡¹ã€æ•ˆæœï¼‰

        Args:
            character: è§’è‰²æ•°æ®
            history: å¯¹è¯å†å²

        Returns:
            å®Œæ•´çš„ prompt
        """
        personality_type = character.get("personality_type", "tsundere")
        affection = character.get("affection", 0)
        intimacy = character.get("intimacy", 0)
        trust = character.get("trust", 0)
        corruption = character.get("corruption", 0)
        submission = character.get("submission", 0)
        desire = character.get("desire", 0)
        shame = character.get("shame", 0)
        resistance = character.get("resistance", 0)
        game_day = character.get("game_day", 1)
        career = character.get("career", "é«˜ä¸­ç”Ÿ")
        coins = character.get("coins", 100)

        # æ„å»ºå…³ç³»é˜¶æ®µæè¿°
        if intimacy < 20:
            relationship = "é™Œç”Ÿäººé˜¶æ®µ"
        elif intimacy < 50:
            relationship = "æœ‹å‹é˜¶æ®µ"
        elif intimacy < 80:
            relationship = "äº²å¯†é˜¶æ®µ"
        else:
            relationship = "æ‹äººé˜¶æ®µ"

        # æ„å»ºå†å²å¯¹è¯ä¸Šä¸‹æ–‡
        history_context = ""
        if history:
            recent_interactions = []
            for h in history[-5:]:
                if h.get("user"):
                    recent_interactions.append(f"ç©å®¶: {h['user']}")
                if h.get("assistant"):
                    recent_interactions.append(f"è§’è‰²: {h['assistant']}")
            if recent_interactions:
                history_context = f"""
æœ€è¿‘çš„äº’åŠ¨è®°å½•:
{chr(10).join(recent_interactions)}
"""

        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº’åŠ¨æ¸¸æˆè®¾è®¡å¸ˆï¼Œæ­£åœ¨ä¸ºæ‹çˆ±å…»æˆæ¸¸æˆè®¾è®¡éšæœºäº‹ä»¶ã€‚

# æ¸¸æˆèƒŒæ™¯
è¿™æ˜¯ä¸€ä¸ªæ‹çˆ±å…»æˆæ¸¸æˆï¼Œç©å®¶ä¸ä¸€ä½å°‘å¥³åŸ¹å…»å…³ç³»ã€‚æ¸¸æˆæœ‰ä¹ç»´å±æ€§ç³»ç»Ÿï¼Œé€šè¿‡å„ç§äº’åŠ¨å’Œéšæœºäº‹ä»¶æ¨è¿›å‰§æƒ…ã€‚

# å½“å‰æ¸¸æˆçŠ¶æ€
äººæ ¼ç±»å‹: {personality_type}
æ¸¸æˆè¿›åº¦: ç¬¬{game_day}å¤© (å…±42å¤©)
å…³ç³»é˜¶æ®µ: {relationship}
èŒä¸š: {career}
é‡‘å¸: {coins}

æ ¸å¿ƒå±æ€§:
- å¥½æ„Ÿåº¦: {affection}/100
- äº²å¯†åº¦: {intimacy}/100
- ä¿¡ä»»åº¦: {trust}/100
- å •è½åº¦: {corruption}/100
- é¡ºä»åº¦: {submission}/100
- æ¬²æœ›å€¼: {desire}/100
- ç¾è€»å¿ƒ: {shame}/100
- æŠµæŠ—åº¦: {resistance}/100
{history_context}
# ä»»åŠ¡è¦æ±‚
è¯·æ ¹æ®å½“å‰çŠ¶æ€å’Œå†å²äº’åŠ¨ï¼Œåˆ›é€ ä¸€ä¸ª**å…¨æ–°çš„éšæœºäº‹ä»¶**ã€‚

äº‹ä»¶åº”è¯¥ï¼š
1. **è‡ªç„¶èå…¥å½“å‰æƒ…å¢ƒ** - ç¬¦åˆè§’è‰²å…³ç³»é˜¶æ®µå’Œæœ€è¿‘å‘ç”Ÿçš„äº‹æƒ…
2. **æœ‰æˆå‰§æ€§** - å¸¦æ¥æ„å¤–ã€å†²çªæˆ–è½¬æœº
3. **æœ‰çœŸå®çš„é€‰æ‹©å›°å¢ƒ** - é€‰é¡¹ä¹‹é—´æœ‰æ˜æ˜¾åŒºåˆ«å’Œæƒè¡¡
4. **å½±å“å…³ç³»å‘å±•** - é€šè¿‡å±æ€§å˜åŒ–æ¨åŠ¨å‰§æƒ…

äº‹ä»¶å¯ä»¥æ¶‰åŠï¼ˆä½†ä¸é™äºï¼‰ï¼š
- æ—¥å¸¸ç”Ÿæ´»äº‹ä»¶ï¼ˆå¤©æ°”ã€è´­ç‰©ã€èšä¼šã€èŠ‚æ—¥ï¼‰
- äººé™…å…³ç³»ï¼ˆæœ‹å‹ã€å®¶äººã€å‰ä»»ã€é™Œç”Ÿäººï¼‰
- æƒ…æ„Ÿæ—¶åˆ»ï¼ˆäº‰åµã€å’Œè§£ã€è¡¨ç™½ã€è¯¯ä¼šï¼‰
- æ„å¤–çŠ¶å†µï¼ˆç”Ÿç—…ã€å—ä¼¤ã€è¿·è·¯ã€å±é™©ï¼‰
- ç¤¾äº¤åœºåˆï¼ˆçº¦ä¼šã€èšä¼šã€å…¬å…±åœºæ‰€ï¼‰
- ä¸ªäººå›°å¢ƒï¼ˆå·¥ä½œ/å­¦ä¸šå‹åŠ›ã€é“å¾·é€‰æ‹©ã€å¿ƒç†å†²çªï¼‰

# è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{{
  "event_name": "äº‹ä»¶åç§°ï¼ˆ3-6å­—ï¼‰",
  "event_category": "äº‹ä»¶ç±»åˆ«ï¼ˆsocial/work/romance/crisis/specialä¹‹ä¸€ï¼‰",
  "event_emoji": "ä»£è¡¨äº‹ä»¶çš„emojiï¼ˆä¸€ä¸ªï¼‰",
  "story_text": "äº‹ä»¶æè¿°ï¼ˆ60-120å­—ï¼Œæè¿°å‘ç”Ÿäº†ä»€ä¹ˆï¼Œä»¥å¥¹çš„å¯¹è¯æˆ–æƒ…å¢ƒæå†™ç»“å°¾ï¼‰",
  "choices": [
    {{
      "text": "é€‰é¡¹1æ ‡é¢˜ï¼ˆ10-20å­—ï¼‰",
      "result_text": "é€‰æ‹©åçš„ç»“æœï¼ˆ40-80å­—ï¼ŒåŒ…å«å¥¹çš„ååº”ï¼‰",
      "effects": {{
        "affection": 0,
        "intimacy": 0,
        "trust": 0,
        "corruption": 0,
        "submission": 0,
        "desire": 0,
        "arousal": 0,
        "resistance": 0,
        "shame": 0,
        "coins": 0
      }},
      "requirements": {{}}
    }},
    {{
      "text": "é€‰é¡¹2æ ‡é¢˜",
      "result_text": "é€‰æ‹©åçš„ç»“æœ",
      "effects": {{
        "affection": 0,
        "intimacy": 0,
        "trust": 0
      }},
      "requirements": {{}}
    }},
    {{
      "text": "é€‰é¡¹3æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰",
      "result_text": "é€‰æ‹©åçš„ç»“æœ",
      "effects": {{}},
      "requirements": {{
        "intimacy": 40
      }}
    }}
  ]
}}
```

# effects å±æ€§å˜åŒ–è§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰
æ ¹æ®é€‰é¡¹æ€§è´¨è®¾ç½®åˆç†çš„æ•°å€¼ï¼š

**æ¸©æŸ”/å…³æ€€é€‰é¡¹**: affection +8~15, trust +5~12, intimacy +3~8
**å¤§èƒ†/äº²å¯†é€‰é¡¹**: intimacy +10~20, arousal +8~15, shame -5~-15, corruption +5~10
**æ‹’ç»/å†·æ·¡é€‰é¡¹**: affection -10~-20, trust -8~-15, resistance +10~20
**é¡ºä»/è¿åˆé€‰é¡¹**: submission +8~15, affection +5~10, trustå¯èƒ½-3~-8
**æŒ‘æˆ˜/æŒ‘é€—é€‰é¡¹**: desire +10~18, corruption +8~15, shame -8~-15
**èŠ±è´¹é‡‘å¸**: coins -20~-100ï¼ˆæ ¹æ®é€‰é¡¹è®¾å®šï¼‰
**è·å¾—é‡‘å¸**: coins +20~+80

æ¯ä¸ªé€‰é¡¹çš„ effects åº”è¯¥ï¼š
- è‡³å°‘å½±å“2-4ä¸ªå±æ€§
- æœ‰æ­£å‘å’Œè´Ÿå‘å˜åŒ–çš„æƒè¡¡
- æ•°å€¼èŒƒå›´ -25 åˆ° +25 ä¹‹é—´
- requirements ç”¨äºé™åˆ¶é«˜çº§é€‰é¡¹ï¼ˆå¦‚ "intimacy": 50 è¡¨ç¤ºéœ€è¦äº²å¯†åº¦â‰¥50ï¼‰

# æ³¨æ„äº‹é¡¹
1. äº‹ä»¶è¦**ç¬¦åˆå½“å‰å…³ç³»é˜¶æ®µ**ï¼š
   - é™Œç”Ÿäººé˜¶æ®µï¼šæ—¥å¸¸å¶é‡ã€å°è¯¯ä¼šã€ç®€å•äº’åŠ¨
   - æœ‹å‹é˜¶æ®µï¼šå…±åŒæ´»åŠ¨ã€å°å†²çªã€æ¸è¿›äº²å¯†
   - äº²å¯†é˜¶æ®µï¼šæƒ…æ„Ÿçº è‘›ã€æ·±å…¥äº’åŠ¨ã€å…³ç³»è€ƒéªŒ
   - æ‹äººé˜¶æ®µï¼šæ·±å±‚çŸ›ç›¾ã€æ¿€æƒ…æ—¶åˆ»ã€æœªæ¥è§„åˆ’

2. äº‹ä»¶è¦**ä¸æœ€è¿‘äº’åŠ¨æœ‰å…³è”**ï¼ˆå¦‚æœæœ‰å†å²ï¼‰

3. é€‰é¡¹è¦**æœ‰çœŸå®çš„ä¸¤éš¾**ï¼Œä¸è¦æœ‰æ˜æ˜¾çš„"æœ€ä¼˜è§£"

4. è§’è‰²å¯¹è¯åŠ å¼•å·ã€Œã€æˆ–""

5. åªè¾“å‡ºJSONï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—

6. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥è¢«è§£æ

ç°åœ¨è¯·ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„éšæœºäº‹ä»¶ã€‚
"""

        return prompt.strip()

    @staticmethod
    def build_dynamic_dilemma_prompt(
        character: Dict,
        history: List[Dict] = None
    ) -> str:
        """
        æ„å»ºå®Œå…¨åŠ¨æ€çš„å›°å¢ƒç”Ÿæˆ Promptï¼ˆåŒ…æ‹¬å›°å¢ƒç±»å‹ã€é€‰é¡¹ã€æ•ˆæœï¼‰

        Args:
            character: è§’è‰²æ•°æ®
            history: å¯¹è¯å†å²

        Returns:
            å®Œæ•´çš„ prompt
        """
        personality_type = character.get("personality_type", "tsundere")
        affection = character.get("affection", 0)
        intimacy = character.get("intimacy", 0)
        trust = character.get("trust", 0)
        corruption = character.get("corruption", 0)
        submission = character.get("submission", 0)
        desire = character.get("desire", 0)
        shame = character.get("shame", 0)
        resistance = character.get("resistance", 0)
        game_day = character.get("game_day", 1)
        career = character.get("career", "é«˜ä¸­ç”Ÿ")
        coins = character.get("coins", 100)

        # æ„å»ºå…³ç³»é˜¶æ®µæè¿°
        if intimacy < 20:
            relationship = "é™Œç”Ÿäººé˜¶æ®µ"
        elif intimacy < 50:
            relationship = "æœ‹å‹é˜¶æ®µ"
        elif intimacy < 80:
            relationship = "äº²å¯†é˜¶æ®µ"
        else:
            relationship = "æ‹äººé˜¶æ®µ"

        # æ„å»ºå†å²å¯¹è¯ä¸Šä¸‹æ–‡
        history_context = ""
        if history:
            recent_interactions = []
            for h in history[-5:]:
                if h.get("user"):
                    recent_interactions.append(f"ç©å®¶: {h['user']}")
                if h.get("assistant"):
                    recent_interactions.append(f"è§’è‰²: {h['assistant']}")
            if recent_interactions:
                history_context = f"""
æœ€è¿‘çš„äº’åŠ¨è®°å½•:
{chr(10).join(recent_interactions)}
"""

        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº’åŠ¨æ¸¸æˆè®¾è®¡å¸ˆï¼Œæ­£åœ¨ä¸ºæ‹çˆ±å…»æˆæ¸¸æˆè®¾è®¡**é€‰æ‹©å›°å¢ƒ**ã€‚

# æ¸¸æˆèƒŒæ™¯
è¿™æ˜¯ä¸€ä¸ªæ‹çˆ±å…»æˆæ¸¸æˆï¼Œç©å®¶ä¸ä¸€ä½å°‘å¥³åŸ¹å…»å…³ç³»ã€‚é€‰æ‹©å›°å¢ƒæ˜¯æ¸¸æˆä¸­çš„å…³é”®è½¬æŠ˜ç‚¹ï¼Œå¼ºè¿«ç©å®¶åšå‡ºè‰°éš¾çš„å†³ç­–ã€‚

# å½“å‰æ¸¸æˆçŠ¶æ€
äººæ ¼ç±»å‹: {personality_type}
æ¸¸æˆè¿›åº¦: ç¬¬{game_day}å¤© (å…±42å¤©)
å…³ç³»é˜¶æ®µ: {relationship}
èŒä¸š: {career}
é‡‘å¸: {coins}

æ ¸å¿ƒå±æ€§:
- å¥½æ„Ÿåº¦: {affection}/100
- äº²å¯†åº¦: {intimacy}/100
- ä¿¡ä»»åº¦: {trust}/100
- å •è½åº¦: {corruption}/100
- é¡ºä»åº¦: {submission}/100
- æ¬²æœ›å€¼: {desire}/100
- ç¾è€»å¿ƒ: {shame}/100
- æŠµæŠ—åº¦: {resistance}/100
{history_context}
# ä»»åŠ¡è¦æ±‚
è¯·æ ¹æ®å½“å‰çŠ¶æ€å’Œå†å²äº’åŠ¨ï¼Œåˆ›é€ ä¸€ä¸ª**å…¨æ–°çš„é€‰æ‹©å›°å¢ƒ**ã€‚

é€‰æ‹©å›°å¢ƒåº”è¯¥ï¼š
1. **å¼ºè¿«ç©å®¶åšå‡ºè‰°éš¾çš„é€‰æ‹©** - æ²¡æœ‰å®Œç¾ç­”æ¡ˆï¼Œåªæœ‰æƒè¡¡
2. **æœ‰æ·±è¿œå½±å“** - é€‰æ‹©ä¼šå½±å“å…³ç³»çš„æœªæ¥èµ°å‘
3. **ç¬¦åˆå½“å‰å…³ç³»é˜¶æ®µ** - å›°å¢ƒçš„æ€§è´¨è¦ä¸äº²å¯†åº¦åŒ¹é…
4. **æœ‰æƒ…æ„Ÿå†²å‡»** - è®©ç©å®¶æ„Ÿå—åˆ°é€‰æ‹©çš„é‡é‡
5. **ä¸æœ€è¿‘äº’åŠ¨æœ‰å…³** - å¦‚æœæœ‰å†å²è®°å½•ï¼Œå›°å¢ƒè¦æœ‰è¿è´¯æ€§

å›°å¢ƒç±»å‹å¯ä»¥æ¶‰åŠï¼ˆä½†ä¸é™äºï¼‰ï¼š
- é“å¾·å†²çªï¼ˆç†æ™ºvsæ¬²æœ›ã€åŸåˆ™vsæ„Ÿæƒ…ï¼‰
- ä¿¡ä»»å±æœºï¼ˆçœŸç›¸vsè°è¨€ã€å¦è¯švséšç’ï¼‰
- æ‰¿è¯ºè€ƒéªŒï¼ˆå±¥è¡Œvsè¿èƒŒã€ä»˜å‡ºvsä¿ç•™ï¼‰
- å…³ç³»åˆ†å²”ï¼ˆè®¤çœŸvsæš§æ˜§ã€æ‰¿è¯ºvsè‡ªç”±ï¼‰
- ç‰ºç‰²è¦æ±‚ï¼ˆä¸ºå¥¹ä»˜å‡ºvsä¿æŠ¤è‡ªå·±ï¼‰
- å¿ è¯šè€ƒéªŒï¼ˆå¥¹vsä»–äººã€ç‹¬å vsåˆ†äº«ï¼‰
- åº•çº¿æŠ‰æ‹©ï¼ˆé“å¾·åº•çº¿vså¥¹çš„è¦æ±‚ï¼‰

# è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{{
  "dilemma_name": "å›°å¢ƒåç§°ï¼ˆ3-6å­—ï¼‰",
  "dilemma_emoji": "ä»£è¡¨å›°å¢ƒçš„emojiï¼ˆä¸€ä¸ªï¼‰",
  "title": "å›°å¢ƒæ ‡é¢˜ï¼ˆåŒ…å«emojiï¼Œå¦‚ï¼šğŸ’” ã€é“å¾·çš„åå­—è·¯å£ã€‘ï¼‰",
  "description": "å›°å¢ƒæè¿°ï¼ˆ80-150å­—ï¼Œæè¿°å…³é”®æ—¶åˆ»å’Œå¥¹çš„çŠ¶æ€ï¼Œä»¥'ç°åœ¨ï¼Œä½ å¿…é¡»åšå‡ºé€‰æ‹©ï¼š'æˆ–ç±»ä¼¼å¼•å¯¼è¯­ç»“å°¾ï¼‰",
  "choices": [
    {{
      "id": "choice_1_id",
      "text": "é€‰é¡¹1æ ‡é¢˜ï¼ˆ10-20å­—ï¼‰",
      "description": "é€‰é¡¹1è¯´æ˜ï¼ˆ15-30å­—ï¼Œè¡¥å……è¯´æ˜è¿™ä¸ªé€‰æ‹©çš„å«ä¹‰ï¼‰",
      "effects": {{
        "affection": 0,
        "intimacy": 0,
        "trust": 0,
        "corruption": 0,
        "submission": 0,
        "desire": 0,
        "arousal": 0,
        "resistance": 0,
        "shame": 0,
        "coins": 0
      }},
      "consequence_text": "é€‰æ‹©åçš„å³æ—¶åæœï¼ˆ40-80å­—ï¼ŒåŒ…å«å¥¹çš„ååº”ï¼‰",
      "long_term": "é•¿æœŸå½±å“æè¿°ï¼ˆ20-40å­—ï¼Œè¿™ä¸ªé€‰æ‹©çš„æ·±è¿œå½±å“ï¼‰"
    }},
    {{
      "id": "choice_2_id",
      "text": "é€‰é¡¹2æ ‡é¢˜",
      "description": "é€‰é¡¹2è¯´æ˜",
      "effects": {{
        "affection": 0,
        "intimacy": 0,
        "trust": 0
      }},
      "consequence_text": "é€‰æ‹©åçš„å³æ—¶åæœ",
      "long_term": "é•¿æœŸå½±å“æè¿°"
    }}
  ]
}}
```

# effects å±æ€§å˜åŒ–è§„åˆ™ï¼ˆé‡è¦ï¼ï¼‰
æ ¹æ®é€‰æ‹©çš„æ€§è´¨è®¾ç½®åˆç†çš„æ•°å€¼ï¼Œç¡®ä¿ä¸¤ä¸ªé€‰æ‹©æœ‰æ˜æ˜¾çš„æƒè¡¡ï¼š

**ç¤ºä¾‹1 - é“å¾·å›°å¢ƒ**:
- é€‰é¡¹Aï¼ˆæ»¡è¶³æ¬²æœ›ï¼‰: desire +20, arousal +15, corruption +10, shame -20, trust -15
- é€‰é¡¹Bï¼ˆä¿æŠ¤å°Šä¸¥ï¼‰: trust +25, affection +15, desire -10, arousal -20

**ç¤ºä¾‹2 - ä¿¡ä»»å±æœº**:
- é€‰é¡¹Aï¼ˆå¦è¯šçœŸç›¸ï¼‰: trust +30, affection -25, resistance +20, corruption -15
- é€‰é¡¹Bï¼ˆå–„æ„è°è¨€ï¼‰: affection +20, trust -10, submission +10

**ç¤ºä¾‹3 - æ‰¿è¯ºè€ƒéªŒ**:
- é€‰é¡¹Aï¼ˆå±¥è¡Œæ‰¿è¯ºï¼‰: trust +40, affection +30, coins -200
- é€‰é¡¹Bï¼ˆè¿èƒŒæ‰¿è¯ºï¼‰: trust -40, affection -25, resistance +25, coins +0

**æ•ˆæœè®¾ç½®åŸåˆ™**:
- æ¯ä¸ªé€‰é¡¹åº”å½±å“ 3-6 ä¸ªå±æ€§
- å¿…é¡»æœ‰æ­£å‘å’Œè´Ÿå‘å˜åŒ–çš„æƒè¡¡
- æ•°å€¼èŒƒå›´ -50 åˆ° +50 ä¹‹é—´
- å›°å¢ƒè¶Šé‡å¤§ï¼Œå±æ€§å˜åŒ–è¶Šå¤§
- ä¸è¦æœ‰æ˜æ˜¾çš„"æœ€ä¼˜è§£"

# æ³¨æ„äº‹é¡¹
1. å›°å¢ƒè¦**ç¬¦åˆå½“å‰å…³ç³»é˜¶æ®µ**ï¼š
   - é™Œç”Ÿäººé˜¶æ®µï¼šç®€å•çš„ä¿¡ä»»è€ƒéªŒã€å°è¯¯ä¼š
   - æœ‹å‹é˜¶æ®µï¼šå‹æƒ…vsçˆ±æƒ…ã€ç•Œé™è¯•æ¢
   - äº²å¯†é˜¶æ®µï¼šæ·±å±‚çŸ›ç›¾ã€é“å¾·å›°å¢ƒã€æ‰¿è¯ºè€ƒéªŒ
   - æ‹äººé˜¶æ®µï¼šå…³ç³»å®šä¹‰ã€æœªæ¥è§„åˆ’ã€ç‰ºç‰²è¦æ±‚

2. å›°å¢ƒè¦**ä¸æœ€è¿‘äº’åŠ¨æœ‰å…³è”**ï¼ˆå¦‚æœæœ‰å†å²ï¼‰

3. ä¸¤ä¸ªé€‰é¡¹è¦**å½¢æˆçœŸæ­£çš„å¯¹ç«‹**ï¼Œæ²¡æœ‰æ˜æ˜¾çš„å¥½åä¹‹åˆ†

4. è§’è‰²å¯¹è¯åŠ å¼•å·ã€Œã€æˆ–""

5. åªè¾“å‡ºJSONï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—

6. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥è¢«è§£æ

7. choice_id ä½¿ç”¨ç®€çŸ­çš„è‹±æ–‡æ ‡è¯†ç¬¦ï¼ˆå¦‚ satisfy_desire, protect_dignityï¼‰

ç°åœ¨è¯·ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„é€‰æ‹©å›°å¢ƒã€‚
"""

        return prompt.strip()

    @staticmethod
    def build_event_prompt(
        event_category: str,
        event_name: str,
        character: Dict,
        history: List[Dict] = None,
        num_choices: int = 2
    ) -> str:
        """
        æ„å»ºäº‹ä»¶ç”Ÿæˆçš„ Prompt

        Args:
            event_category: äº‹ä»¶ç±»åˆ« (social/work/health/special)
            event_name: äº‹ä»¶åç§°
            character: è§’è‰²æ•°æ®
            history: å¯¹è¯å†å²
            num_choices: é€‰é¡¹æ•°é‡ï¼ˆ2-4ä¸ªï¼‰

        Returns:
            å®Œæ•´çš„ prompt
        """
        # è·å–è§’è‰²åŸºæœ¬ä¿¡æ¯
        personality_type = character.get("personality_type", "tsundere")
        affection = character.get("affection", 0)
        intimacy = character.get("intimacy", 0)
        trust = character.get("trust", 0)
        corruption = character.get("corruption", 0)
        submission = character.get("submission", 0)
        game_day = character.get("game_day", 1)

        # æ„å»ºå…³ç³»é˜¶æ®µæè¿°
        if intimacy < 20:
            relationship = "é™Œç”Ÿäººé˜¶æ®µï¼Œåˆšå¼€å§‹è®¤è¯†"
        elif intimacy < 50:
            relationship = "æœ‹å‹é˜¶æ®µï¼Œå·²ç»æ¯”è¾ƒç†Ÿæ‚‰"
        elif intimacy < 80:
            relationship = "äº²å¯†é˜¶æ®µï¼Œå…³ç³»å¯†åˆ‡"
        else:
            relationship = "æ‹äººé˜¶æ®µï¼Œéå¸¸äº²å¯†"

        # æ„å»ºå†å²å¯¹è¯ä¸Šä¸‹æ–‡
        history_context = ""
        if history:
            recent_interactions = []
            for h in history[-3:]:  # æœ€è¿‘3æ¡
                if h.get("user"):
                    recent_interactions.append(f"ç©å®¶: {h['user']}")
                if h.get("assistant"):
                    recent_interactions.append(f"è§’è‰²: {h['assistant']}")
            if recent_interactions:
                history_context = f"""
æœ€è¿‘çš„äº’åŠ¨:
{chr(10).join(recent_interactions)}
"""

        # ç±»åˆ«ç›¸å…³çš„ç‰¹æ®Šè¯´æ˜
        category_notes = {
            "social": "æ¶‰åŠäººé™…å…³ç³»ã€æœ‹å‹ã€å®¶äººã€ç¤¾äº¤åœºåˆç­‰",
            "work": "æ¶‰åŠå·¥ä½œã€å­¦ä¹ ã€è€ƒè¯•ã€å‹åŠ›ç­‰",
            "health": "æ¶‰åŠèº«ä½“çŠ¶å†µã€æƒ…ç»ªçŠ¶æ€ã€å¥åº·é—®é¢˜ç­‰",
            "special": "ç‰¹æ®Šæƒ…å¢ƒã€æµªæ¼«æ—¶åˆ»ã€æ„å¤–çŠ¶å†µç­‰"
        }

        category_note = category_notes.get(event_category, "")

        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº’åŠ¨æ¸¸æˆæ–‡æ¡ˆä½œå®¶ï¼Œæ­£åœ¨ä¸ºä¸€ä¸ªæ‹çˆ±å…»æˆæ¸¸æˆç”Ÿæˆéšæœºäº‹ä»¶ã€‚

# æ¸¸æˆèƒŒæ™¯
è¿™æ˜¯ä¸€ä¸ªæ‹çˆ±å…»æˆæ¸¸æˆï¼Œç©å®¶æ­£åœ¨åŸ¹å…»ä¸ä¸€ä½å°‘å¥³çš„å…³ç³»ã€‚æ¸¸æˆçš„æ ¸å¿ƒæ˜¯ä¹ç»´å±æ€§ç³»ç»Ÿå’Œé€‰æ‹©-åæœæœºåˆ¶ã€‚

# å½“å‰è§’è‰²çŠ¶æ€
äººæ ¼ç±»å‹: {personality_type}
æ¸¸æˆè¿›åº¦: ç¬¬{game_day}å¤©
å…³ç³»é˜¶æ®µ: {relationship}

å±æ€§å€¼:
- å¥½æ„Ÿåº¦: {affection}/100
- äº²å¯†åº¦: {intimacy}/100
- ä¿¡ä»»åº¦: {trust}/100
- å •è½åº¦: {corruption}/100
- é¡ºä»åº¦: {submission}/100
{history_context}
# äº‹ä»¶ç±»å‹
äº‹ä»¶ç±»åˆ«: {event_category} ({category_note})
äº‹ä»¶åç§°: {event_name}

# ä»»åŠ¡è¦æ±‚
è¯·åŸºäºå½“å‰è§’è‰²çŠ¶æ€å’Œå†å²äº’åŠ¨ï¼Œç”Ÿæˆä¸€ä¸ª**{event_name}**ç›¸å…³çš„éšæœºäº‹ä»¶ï¼ŒåŒ…æ‹¬ï¼š

1. **äº‹ä»¶æè¿°** (story_text):
   - 50-100å­—
   - ç¬¬ä¸‰äººç§°æè¿°å½“å‰å‘ç”Ÿçš„æƒ…å†µ
   - ç¬¦åˆè§’è‰²äººæ ¼ç‰¹ç‚¹
   - ä¸å†å²äº’åŠ¨æœ‰ä¸€å®šè¿è´¯æ€§
   - è¯­è¨€ç”ŸåŠ¨ï¼Œæœ‰ç”»é¢æ„Ÿ
   - ä»¥çœç•¥å·ç»“å°¾ï¼Œç•™ä¸‹æ‚¬å¿µ

2. **é€‰é¡¹åˆ—è¡¨** ({num_choices}ä¸ªé€‰é¡¹):
   æ¯ä¸ªé€‰é¡¹åŒ…å«ï¼š
   - **é€‰é¡¹æ–‡å­—** (10-20å­—): ç©å®¶å¯ä»¥åšå‡ºçš„é€‰æ‹©
   - **ç»“æœæ–‡æœ¬** (30-60å­—): è§’è‰²å¯¹è¯¥é€‰æ‹©çš„ååº”ï¼ŒåŒ…å«å¯¹è¯æˆ–å¿ƒç†æå†™

# é€‰é¡¹è®¾è®¡åŸåˆ™
- é€‰é¡¹1: æ¸©æŸ”/ç§¯æ/å…³æ€€çš„é€‰æ‹©ï¼ˆé€šå¸¸å¢åŠ å¥½æ„Ÿã€ä¿¡ä»»ï¼‰
- é€‰é¡¹2: ä¸­ç«‹/æ™®é€šçš„é€‰æ‹©
- é€‰é¡¹{num_choices}: å¤§èƒ†/äº²å¯†/æŒ‘æˆ˜æ€§çš„é€‰æ‹©ï¼ˆé€šå¸¸å¢åŠ äº²å¯†åº¦ã€å •è½åº¦ï¼Œä½†å¯èƒ½é™ä½ä¿¡ä»»ï¼‰

é€‰é¡¹ä¹‹é—´è¦æœ‰æ˜æ˜¾åŒºåˆ«ï¼Œç»™ç©å®¶çœŸæ­£çš„å†³ç­–å›°å¢ƒã€‚

# è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{{
  "story_text": "äº‹ä»¶æè¿°æ–‡æœ¬...",
  "choices": [
    {{
      "text": "é€‰é¡¹1æ–‡å­—",
      "result_text": "é€‰é¡¹1çš„ç»“æœæ–‡æœ¬ï¼ˆåŒ…å«è§’è‰²ååº”ï¼‰"
    }},
    {{
      "text": "é€‰é¡¹2æ–‡å­—",
      "result_text": "é€‰é¡¹2çš„ç»“æœæ–‡æœ¬ï¼ˆåŒ…å«è§’è‰²ååº”ï¼‰"
    }}
  ]
}}
```

# æ³¨æ„äº‹é¡¹
1. æ–‡æœ¬å¿…é¡»ç¬¦åˆè§’è‰²çš„{personality_type}äººæ ¼ç‰¹ç‚¹
2. æ ¹æ®å½“å‰å±æ€§å€¼è°ƒæ•´è¯­æ°”å’Œäº²å¯†ç¨‹åº¦
3. äº‹ä»¶è¦è‡ªç„¶èå…¥å½“å‰å…³ç³»é˜¶æ®µï¼Œä¸è¦è¿‡äºçªå…€
4. è§’è‰²çš„å¯¹è¯è¦åŠ å¼•å·ã€Œã€æˆ–""
5. åªè¾“å‡ºJSONï¼Œä¸è¦æœ‰ä»»ä½•å…¶ä»–è¯´æ˜æ–‡å­—
6. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®ï¼Œå¯ä»¥è¢«ç›´æ¥è§£æ

ç°åœ¨è¯·ç”Ÿæˆäº‹ä»¶å†…å®¹ã€‚
"""

        return prompt.strip()

    @staticmethod
    def build_dilemma_prompt(
        dilemma_name: str,
        dilemma_theme: str,
        character: Dict,
        history: List[Dict] = None,
        num_choices: int = 2
    ) -> str:
        """
        æ„å»ºé€‰æ‹©å›°å¢ƒç”Ÿæˆçš„ Prompt

        Args:
            dilemma_name: å›°å¢ƒåç§°
            dilemma_theme: å›°å¢ƒä¸»é¢˜æè¿°
            character: è§’è‰²æ•°æ®
            history: å¯¹è¯å†å²
            num_choices: é€‰é¡¹æ•°é‡ï¼ˆé€šå¸¸æ˜¯2ä¸ªï¼‰

        Returns:
            å®Œæ•´çš„ prompt
        """
        personality_type = character.get("personality_type", "tsundere")
        affection = character.get("affection", 0)
        intimacy = character.get("intimacy", 0)
        trust = character.get("trust", 0)
        corruption = character.get("corruption", 0)
        submission = character.get("submission", 0)
        desire = character.get("desire", 0)
        shame = character.get("shame", 0)
        game_day = character.get("game_day", 1)

        # æ„å»ºå…³ç³»é˜¶æ®µæè¿°
        if intimacy < 20:
            relationship = "é™Œç”Ÿäººé˜¶æ®µ"
        elif intimacy < 50:
            relationship = "æœ‹å‹é˜¶æ®µ"
        elif intimacy < 80:
            relationship = "äº²å¯†é˜¶æ®µ"
        else:
            relationship = "æ‹äººé˜¶æ®µ"

        # æ„å»ºå†å²å¯¹è¯ä¸Šä¸‹æ–‡
        history_context = ""
        if history:
            recent_interactions = []
            for h in history[-3:]:
                if h.get("user"):
                    recent_interactions.append(f"ç©å®¶: {h['user']}")
                if h.get("assistant"):
                    recent_interactions.append(f"è§’è‰²: {h['assistant']}")
            if recent_interactions:
                history_context = f"""
æœ€è¿‘çš„äº’åŠ¨:
{chr(10).join(recent_interactions)}
"""

        prompt = f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„äº’åŠ¨æ¸¸æˆæ–‡æ¡ˆä½œå®¶ï¼Œæ­£åœ¨ä¸ºæ‹çˆ±å…»æˆæ¸¸æˆç”Ÿæˆ**é€‰æ‹©å›°å¢ƒ**äº‹ä»¶ã€‚

# æ¸¸æˆèƒŒæ™¯
è¿™æ˜¯ä¸€ä¸ªæ‹çˆ±å…»æˆæ¸¸æˆï¼Œé€‰æ‹©å›°å¢ƒæ˜¯å…³é”®çš„æƒ…èŠ‚è½¬æŠ˜ç‚¹ï¼Œå¼ºè¿«ç©å®¶åšå‡ºè‰°éš¾çš„é€‰æ‹©ï¼Œæ¯ä¸ªé€‰æ‹©éƒ½æœ‰ä»£ä»·ï¼Œå½±å“åç»­å‘å±•ã€‚

# å½“å‰è§’è‰²çŠ¶æ€
äººæ ¼ç±»å‹: {personality_type}
æ¸¸æˆè¿›åº¦: ç¬¬{game_day}å¤©
å…³ç³»é˜¶æ®µ: {relationship}

æ ¸å¿ƒå±æ€§:
- å¥½æ„Ÿåº¦: {affection}/100
- äº²å¯†åº¦: {intimacy}/100
- ä¿¡ä»»åº¦: {trust}/100
- å •è½åº¦: {corruption}/100
- é¡ºä»åº¦: {submission}/100
- æ¬²æœ›å€¼: {desire}/100
- ç¾è€»å¿ƒ: {shame}/100
{history_context}
# å›°å¢ƒç±»å‹
å›°å¢ƒåç§°: {dilemma_name}
å›°å¢ƒä¸»é¢˜: {dilemma_theme}

# ä»»åŠ¡è¦æ±‚
ç”Ÿæˆä¸€ä¸ªæ·±åˆ»çš„**{dilemma_name}**æƒ…å¢ƒï¼ŒåŒ…æ‹¬ï¼š

1. **å›°å¢ƒæè¿°** (description):
   - 80-150å­—
   - ç¬¬äºŒ/ä¸‰äººç§°æ··åˆï¼Œæè¿°ä¸€ä¸ªéœ€è¦æŠ‰æ‹©çš„å…³é”®æ—¶åˆ»
   - ä½“ç°è§’è‰²å†…å¿ƒçš„çŸ›ç›¾å’ŒæŒ£æ‰
   - è¥é€ ç´§å¼ æ„Ÿå’Œæƒ…ç»ªå¼ åŠ›
   - å¯ä»¥åŒ…å«è§’è‰²çš„å¯¹è¯ï¼ˆç”¨å¼•å·ï¼‰
   - æœ€åä¸€å¥æ˜¯"ç°åœ¨ï¼Œä½ å¿…é¡»åšå‡ºé€‰æ‹©ï¼š"æˆ–ç±»ä¼¼å¼•å¯¼è¯­

2. **é€‰é¡¹åˆ—è¡¨** ({num_choices}ä¸ªé€‰é¡¹):
   æ¯ä¸ªé€‰é¡¹åŒ…å«ï¼š
   - **é€‰é¡¹æ ‡é¢˜** (text): 10-20å­—ï¼Œç®€æ´æ¦‚æ‹¬é€‰æ‹©
   - **é€‰é¡¹è¯´æ˜** (description): 15-30å­—ï¼Œè¡¥å……è¯´æ˜è¿™ä¸ªé€‰æ‹©çš„å«ä¹‰
   - **å³æ—¶åæœ** (consequence_text): 40-80å­—ï¼Œè§’è‰²å¯¹è¯¥é€‰æ‹©çš„å³æ—¶ååº”
   - **é•¿æœŸå½±å“** (long_term): 20-40å­—ï¼Œè¿™ä¸ªé€‰æ‹©çš„æ·±è¿œå½±å“

# é€‰é¡¹è®¾è®¡åŸåˆ™ï¼ˆé‡è¦ï¼ï¼‰
- **æ²¡æœ‰å®Œç¾ç­”æ¡ˆ**ï¼šæ¯ä¸ªé€‰æ‹©éƒ½æœ‰åˆ©å¼Š
- **çœŸå®çš„ä¸¤éš¾**ï¼šé€‰é¡¹ä¹‹é—´å½¢æˆæ˜æ˜¾å¯¹ç«‹
- **æ·±è¿œå½±å“**ï¼šé€‰æ‹©ä¼šå½±å“è§’è‰²æˆé•¿å’Œå…³ç³»èµ°å‘
- **æƒ…æ„Ÿå†²å‡»**ï¼šé€‰æ‹©è¦æœ‰æƒ…æ„Ÿé‡é‡

ç¤ºä¾‹å¯¹æ¯”ï¼š
- é€‰é¡¹A: æ»¡è¶³å¥¹çš„éœ€æ±‚ï¼ˆçŸ­æœŸå¿«ä¹ï¼Œé•¿æœŸä¿¡ä»»ä¸‹é™ï¼‰
- é€‰é¡¹B: å°Šé‡å¥¹çš„çŠ¹è±«ï¼ˆçŸ­æœŸå¤±æœ›ï¼Œé•¿æœŸä¿¡ä»»ä¸Šå‡ï¼‰

# è¾“å‡ºæ ¼å¼
ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¾“å‡ºï¼š

```json
{{
  "description": "å›°å¢ƒæƒ…å¢ƒæè¿°...ä½ å¿…é¡»åšå‡ºé€‰æ‹©ï¼š",
  "choices": [
    {{
      "text": "é€‰é¡¹1æ ‡é¢˜",
      "description": "é€‰é¡¹1è¯´æ˜",
      "consequence_text": "å¥¹çš„å³æ—¶ååº”...",
      "long_term": "é•¿æœŸå½±å“æè¿°"
    }},
    {{
      "text": "é€‰é¡¹2æ ‡é¢˜",
      "description": "é€‰é¡¹2è¯´æ˜",
      "consequence_text": "å¥¹çš„å³æ—¶ååº”...",
      "long_term": "é•¿æœŸå½±å“æè¿°"
    }}
  ]
}}
```

# æ³¨æ„äº‹é¡¹
1. å›°å¢ƒè¦ç¬¦åˆè§’è‰²çš„{personality_type}äººæ ¼
2. æ ¹æ®å½“å‰å±æ€§å€¼è®¾è®¡åˆé€‚æ·±åº¦çš„å›°å¢ƒ
3. å¯¹è¯åŠ å¼•å·ã€Œã€æˆ–""
4. åªè¾“å‡ºJSONï¼Œä¸è¦ä»»ä½•å…¶ä»–æ–‡å­—
5. ç¡®ä¿JSONæ ¼å¼å®Œå…¨æ­£ç¡®

ç°åœ¨è¯·ç”Ÿæˆå›°å¢ƒå†…å®¹ã€‚
"""

        return prompt.strip()

